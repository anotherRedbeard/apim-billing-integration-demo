#!/bin/bash

# APIM Billing Integration Demo - Deployment Script Template
# Copy this file to deploy.sh and update with your actual values

set -e

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}APIM Billing Integration - Deployment${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Check if required parameters are provided
if [ -z "$1" ]; then
  echo -e "${RED}Usage: ./deploy.sh <resource-group-name> [location]${NC}"
  echo ""
  echo "Example:"
  echo "  ./deploy.sh rg-apimbilling-dev southcentralus"
  exit 1
fi

RESOURCE_GROUP=$1
LOCATION=${2:-southcentralus}

# Your APIM configuration - UPDATE THESE VALUES
APIM_NAME="your-apim-instance-name"
APIM_RESOURCE_GROUP="your-apim-resource-group"
AZURE_SUBSCRIPTION_ID="your-subscription-id"

echo -e "${GREEN}Checking Azure CLI...${NC}"
if ! command -v az &> /dev/null; then
    echo -e "${RED}Azure CLI not found. Please install: https://docs.microsoft.com/cli/azure/install-azure-cli${NC}"
    exit 1
fi

echo -e "${GREEN}Creating resource group: $RESOURCE_GROUP${NC}"
az group create \
  --name "$RESOURCE_GROUP" \
  --location "$LOCATION"

echo ""
echo -e "${GREEN}Deploying infrastructure...${NC}"

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

DEPLOYMENT_OUTPUT=$(az deployment group create \
  --resource-group "$RESOURCE_GROUP" \
  --template-file "$SCRIPT_DIR/main.bicep" \
  --parameters "$SCRIPT_DIR/main.bicepparam" \
  --parameters apimName="$APIM_NAME" \
  --parameters apimResourceGroup="$APIM_RESOURCE_GROUP" \
  --query properties.outputs \
  --output json)

echo ""
echo -e "${GREEN}Deployment completed!${NC}"
echo ""

# Extract outputs
FRONTEND_URL=$(echo $DEPLOYMENT_OUTPUT | jq -r '.frontendAppUrl.value')
BACKEND_URL=$(echo $DEPLOYMENT_OUTPUT | jq -r '.backendAppUrl.value')
BACKEND_PRINCIPAL_ID=$(echo $DEPLOYMENT_OUTPUT | jq -r '.backendManagedIdentityPrincipalId.value')

echo -e "${BLUE}Deployment Details:${NC}"
echo "  Frontend URL: $FRONTEND_URL"
echo "  Backend URL: $BACKEND_URL"
echo "  Backend Managed Identity: $BACKEND_PRINCIPAL_ID"
echo ""

echo -e "${GREEN}Configuring RBAC for APIM access...${NC}"

# Automatically assign RBAC if we have the subscription ID
if [ -n "$AZURE_SUBSCRIPTION_ID" ]; then
  APIM_SCOPE="/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$APIM_RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME"
  
  echo "Granting API Management Service Contributor role..."
  az role assignment create \
    --assignee "$BACKEND_PRINCIPAL_ID" \
    --role "API Management Service Contributor" \
    --scope "$APIM_SCOPE" || echo "Role assignment may already exist"
else
  echo "Please run the following command to grant the backend API access to APIM:"
  echo ""
  echo -e "${BLUE}az role assignment create \\${NC}"
  echo -e "${BLUE}  --assignee $BACKEND_PRINCIPAL_ID \\${NC}"
  echo -e "${BLUE}  --role 'API Management Service Contributor' \\${NC}"
  echo -e "${BLUE}  --scope /subscriptions/{your-subscription-id}/resourceGroups/$APIM_RESOURCE_GROUP/providers/Microsoft.ApiManagement/service/$APIM_NAME${NC}"
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Deployment Complete!${NC}"
echo -e "${GREEN}========================================${NC}"
