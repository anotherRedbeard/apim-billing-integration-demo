# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: apim-billing-integration-demo
metadata:
  template: apim-billing-integration-demo

# Define the services that make up this application
services:
  # Backend API Service
  api:
    project: ./src/ApimBilling.Api
    language: csharp
    host: appservice
    
  # Frontend Web Service
  web:
    project: ./src/ApimBilling.Web
    language: csharp
    host: appservice

# Define infrastructure hooks
hooks:
  # Hook to display RBAC instructions after infrastructure is deployed
  postprovision:
    shell: sh
    run: |
      echo "Deployment complete!"
      echo ""
      echo "IMPORTANT: RBAC Configuration Required"
      echo "=========================================="
      
      # Get the backend's managed identity principal ID
      BACKEND_PRINCIPAL_ID=$(azd env get-value BACKEND_MANAGED_IDENTITY_PRINCIPAL_ID 2>/dev/null || echo "")
      
      if [ -n "$BACKEND_PRINCIPAL_ID" ]; then
        echo "Backend Managed Identity Principal ID: $BACKEND_PRINCIPAL_ID"
        echo ""
        echo "To enable APIM billing integration, grant the following role assignment"
        echo "on EACH APIM instance your users will access:"
        echo ""
        echo "  Role: API Management Service Contributor"
        echo "  Assignee: $BACKEND_PRINCIPAL_ID"
        echo ""
        echo "Example command:"
        echo "  az role assignment create \\"
        echo "    --assignee \"$BACKEND_PRINCIPAL_ID\" \\"
        echo "    --role \"API Management Service Contributor\" \\"
        echo "    --scope \"/subscriptions/<SUB_ID>/resourceGroups/<RG>/providers/Microsoft.ApiManagement/service/<APIM_NAME>\""
        echo ""
      else
        echo "Could not retrieve backend managed identity. Check deployment outputs."
      fi
      
      exit 0

